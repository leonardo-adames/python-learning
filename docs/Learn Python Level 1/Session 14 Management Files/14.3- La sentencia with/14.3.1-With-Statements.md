# Learning Python Level 1 - Sesión 10 Bucles

## 14.3.1 With Statements

### Qué es y cómo usar With en Python

El `with statement` es una construcción en **Python** que **simplifica la gestión de recursos que deben ser limpiados después de su uso**. Por ejemplo archivos, conexiones de bases de datos o bloques de código que necesitan liberar recursos específicos.

El principal propósito de `with` es **garantizar que los recursos sean correctamente liberados** o cerrados después de que se haya completado el bloque de código (incluso si se produce una excepción).

>Los beneficios de usar with son:
>- `Simplicidad`: Simplifica el código que maneja recursos.
>- `Seguridad`: Asegura que los recursos se liberen apropiadamente.
>- `Legibilidad`: Hace que el código sea más legible y fácil de seguir.

## Sintaxis de with

La sintaxis básica de la declaración with es la siguiente:

```python
with expresión as variable:
    # Código que usa la variable
```
>- expresión representa un objeto que implementa el protocolo de contexto
>- variable es una referencia a dicho objeto dentro del bloque with.

## Ejemplo básico

Vamos a ver un ejemplo sencillo. Uno de los usos más comunes de `with` es para manejar archivos. La construcción `with` asegura que el archivo sea cerrado adecuadamente después de que se haya terminado de trabajar con él, evitando así posibles fugas de recursos.

```python
# Usando with para manejar un archivo
with open('archivo.txt', 'r') as archivo:
    contenido = archivo.read()
    print(contenido)
# El archivo se cierra automáticamente al salir del bloque with
```
>En este ejemplo, `open('archivo.txt', 'r')` devuelve un objeto archivo que implementa el protocolo de contexto. El archivo se abre para lectura, y al salir del bloque `with`, el archivo se cierra automáticamente, incluso si ocurre una excepción dentro del bloque.

<br>

## Context managers

El `with statement` funciona con objetos conocidos como `context managers`. Estos objetos implementan los métodos especiales `__enter__` y `__exit__`, y controlan la configuración y limpieza del recurso.

`__enter__`: Este método se ejecuta al entrar en el bloque with. Puede realizar configuraciones iniciales y devolver un objeto que se asignará a la variable especificada (si se usa as variable).

`__exit__`: Este método se ejecuta al salir del bloque with. Se encarga de realizar la limpieza, como cerrar archivos o liberar recursos. También puede manejar excepciones si es necesario.

## Implementación de context managers

### Creación de un context manager con clases

Podemos crear nuestros propios context managers utilizando clases e implementando los métodos `__enter__` y `__exit__`.

```python
class MiContexto:
    def __enter__(self):
        print("Entrando en el contexto")
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        print("Saliendo del contexto")
        # Puedes manejar excepciones aquí si es necesario
        return False

# Usando el contexto personalizado
with MiContexto() as contexto:
    print("Dentro del bloque with")
    
# Salida:
# Entrando en el contexto
# Dentro del bloque with
# Saliendo del contexto
```

>En este ejemplo,
>- `MiContexto` es una clase que define los métodos `__enter__` y `__exit__`
>- Al iniciar el bloque `with` se muestra el mensaje “Entrando en el contexto”
>- Dentro del bloque `with`, el cuerpo del bloque imprime “Dentro del bloque with”
>- El bloque `with` asegura que el mensaje “Saliendo del contexto” se imprima al finalizar el bloque, independientemente de si se produce una excepción o no.

### Creación de un context manager con generadores

Otra forma de crear un context manager es **utilizando la función** `contextlib` de la biblioteca estándar de Python **contextmanager**, que proporciona el decorador `@contextmanager`

Este decorador permite definir un administrador de contexto personalizado de una manera más sencilla que implementando la interfaz completa `__enter__` y `__exit__`.

```python
from contextlib import contextmanager

@contextmanager
def mi_contexto():
    print("Entrando al contexto")
    yield
    print("Saliendo del contexto")

with mi_contexto():
    print("Dentro del bloque with")

# Salida:
# Entrando en el contexto
# Dentro del bloque with
# Saliendo del contexto
```
>En este ejemplo,
>- El decorador convierte la función `mi_contexto` en un administrador de contexto que puede ser utilizado con la declaración `with`
>- El contexto tendrá acciones previas y acciones posteriores. Entre ellas, debemos poner un `yield`, y aquí se ejecutarán las acciones del bloque
>- El comportamiento es el mismo que el caso anterior, pero la sintaxis de creación es más sencilla


